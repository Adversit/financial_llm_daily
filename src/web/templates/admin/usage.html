{% extends "base.html" %}

{% block breadcrumb %}è´¹ç”¨ç»Ÿè®¡{% endblock %}

{% block content %}
<style>
    /* Tokenè´¹ç”¨ç»Ÿè®¡æ ·å¼ */
    .usage-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border-radius: 12px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(79, 172, 254, 0.2);
    }

    .usage-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .usage-subtitle {
        font-size: 0.9375rem;
        opacity: 0.95;
    }

    .cost-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .cost-card {
        background: white;
        border-radius: 12px;
        padding: 1.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

    .cost-card::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 80px;
        height: 80px;
        background: radial-gradient(circle, rgba(37, 99, 235, 0.1) 0%, transparent 70%);
    }

    .cost-label {
        font-size: 0.8125rem;
        color: #64748b;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .cost-value {
        font-size: 2.25rem;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 0.5rem;
    }

    .cost-change {
        font-size: 0.8125rem;
        font-weight: 500;
    }

    .change-up {
        color: #ef4444;
    }

    .change-down {
        color: #10b981;
    }

    .provider-list {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .provider-header {
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid #e2e8f0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .provider-item {
        padding: 1.5rem;
        border-bottom: 1px solid #f1f5f9;
    }

    .provider-item:last-child {
        border-bottom: none;
    }

    .provider-top {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }

    .provider-name {
        font-weight: 600;
        color: #0f172a;
        font-size: 1.125rem;
    }

    .provider-cost {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2563eb;
    }

    .provider-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .metric-item {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .metric-label {
        font-size: 0.75rem;
        color: #64748b;
        margin-bottom: 0.375rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-value {
        font-size: 1.125rem;
        font-weight: 600;
        color: #0f172a;
    }

    .usage-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
    }

    .usage-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #2563eb 0%, #1e4976 100%);
        border-radius: 4px;
        transition: width 0.3s;
    }

    .date-filter {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
    }
</style>

<!-- é¡µé¢å¤´éƒ¨ -->
<div class="usage-header">
    <div class="usage-title">ğŸ’° è´¹ç”¨ç»Ÿè®¡</div>
    <div class="usage-subtitle">è·Ÿè¸ªå„LLMæä¾›å•†çš„Tokenä½¿ç”¨é‡å’ŒAPIè°ƒç”¨æˆæœ¬</div>
</div>

<!-- æ—¥æœŸç­›é€‰ -->
<div class="date-filter">
    <div class="filter-row">
        <div class="form-group" style="margin: 0;">
            <label class="form-label">ç»Ÿè®¡å‘¨æœŸ</label>
            <select class="form-control">
                <option value="today">ä»Šæ—¥</option>
                <option value="week">æœ¬å‘¨</option>
                <option value="month" selected>æœ¬æœˆ</option>
                <option value="quarter">æœ¬å­£åº¦</option>
                <option value="year">æœ¬å¹´</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>
        </div>

        <div class="form-group" style="margin: 0;">
            <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
            <input type="date" class="form-control">
        </div>

        <div class="form-group" style="margin: 0;">
            <label class="form-label">ç»“æŸæ—¥æœŸ</label>
            <input type="date" class="form-control">
        </div>

        <button class="btn btn-primary">
            ğŸ” æŸ¥è¯¢
        </button>
    </div>
</div>

<!-- è´¹ç”¨æ¦‚è§ˆ -->
<div class="cost-summary">
    <div class="cost-card">
        <div class="cost-label">ç»Ÿè®¡å‘¨æœŸæ€»è´¹ç”¨</div>
        <div class="cost-value">Â¥{{ "%.2f"|format(total_stats.total_cost) }}</div>
    </div>

    <div class="cost-card">
        <div class="cost-label">æ€»Tokenæ¶ˆè€—</div>
        <div class="cost-value">{{ "%.1fK"|format(total_stats.total_tokens / 1000) if total_stats.total_tokens < 1000000 else "%.1fM"|format(total_stats.total_tokens / 1000000) }}</div>
    </div>

    <div class="cost-card">
        <div class="cost-label">APIè°ƒç”¨æ¬¡æ•°</div>
        <div class="cost-value">{{ "{:,}".format(total_stats.call_count) }}</div>
    </div>

    <div class="cost-card">
        <div class="cost-label">å¹³å‡å•æ¬¡æˆæœ¬</div>
        <div class="cost-value">Â¥{{ "%.4f"|format(total_stats.total_cost / total_stats.call_count) if total_stats.call_count > 0 else "0.00" }}</div>
    </div>
</div>

<!-- æä¾›å•†è¯¦ç»†ç»Ÿè®¡ -->
<div class="provider-list">
    <div class="provider-header">
        <span>ğŸ¤–</span>
        <span>æä¾›å•†æ˜ç»†</span>
    </div>

    {% if providers %}
        {% for provider in providers %}
        <div class="provider-item">
            <div class="provider-top">
                <div>
                    <div class="provider-name">
                        {% if provider.name == "openai" %}ğŸŸ¢
                        {% elif provider.name == "anthropic" %}ğŸŸ£
                        {% elif provider.name == "deepseek" %}ğŸ”µ
                        {% elif provider.name == "qwen" %}ğŸŸ 
                        {% else %}âšª
                        {% endif %}
                        {{ provider.name|title }}
                    </div>
                    <div style="font-size: 0.8125rem; color: #64748b; margin-top: 0.25rem;">
                        {% if provider.models|length == 1 %}
                            {{ provider.models[0].name }}
                        {% else %}
                            {{ provider.models|length }} ä¸ªæ¨¡å‹
                        {% endif %}
                    </div>
                </div>
                <div class="provider-cost">Â¥{{ "%.2f"|format(provider.cost) }}</div>
            </div>

            <div class="provider-metrics">
                <div class="metric-item">
                    <div class="metric-label">Tokenæ¶ˆè€—</div>
                    <div class="metric-value">
                        {% if provider.total_tokens < 1000 %}
                            {{ provider.total_tokens }}
                        {% elif provider.total_tokens < 1000000 %}
                            {{ "%.1fK"|format(provider.total_tokens / 1000) }}
                        {% else %}
                            {{ "%.1fM"|format(provider.total_tokens / 1000000) }}
                        {% endif %}
                    </div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">APIè°ƒç”¨</div>
                    <div class="metric-value">{{ "{:,}".format(provider.call_count) }}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">è¾“å…¥Token</div>
                    <div class="metric-value">
                        {% if provider.prompt_tokens < 1000 %}
                            {{ provider.prompt_tokens }}
                        {% elif provider.prompt_tokens < 1000000 %}
                            {{ "%.1fK"|format(provider.prompt_tokens / 1000) }}
                        {% else %}
                            {{ "%.1fM"|format(provider.prompt_tokens / 1000000) }}
                        {% endif %}
                    </div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">è¾“å‡ºToken</div>
                    <div class="metric-value">
                        {% if provider.completion_tokens < 1000 %}
                            {{ provider.completion_tokens }}
                        {% elif provider.completion_tokens < 1000000 %}
                            {{ "%.1fK"|format(provider.completion_tokens / 1000) }}
                        {% else %}
                            {{ "%.1fM"|format(provider.completion_tokens / 1000000) }}
                        {% endif %}
                    </div>
                </div>
            </div>

            <div style="margin-top: 1rem;">
                {% set usage_percent = (provider.cost / total_stats.total_cost * 100) if total_stats.total_cost > 0 else 0 %}
                <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">è´¹ç”¨å æ¯”: {{ "%.1f"|format(usage_percent) }}%</div>
                <div class="usage-bar">
                    <div class="usage-bar-fill" style="width: {{ usage_percent }}%;"></div>
                </div>
            </div>

            <!-- æ˜¾ç¤ºæ¨¡å‹è¯¦æƒ… -->
            {% if provider.models|length > 1 %}
            <details style="margin-top: 1rem;">
                <summary style="cursor: pointer; color: #2563eb; font-size: 0.875rem; font-weight: 500;">
                    æŸ¥çœ‹æ¨¡å‹æ˜ç»† ({{ provider.models|length }} ä¸ª)
                </summary>
                <div style="margin-top: 0.75rem; padding-left: 1rem; border-left: 2px solid #e2e8f0;">
                    {% for model in provider.models %}
                    <div style="padding: 0.5rem 0; font-size: 0.8125rem;">
                        <div style="font-weight: 600; color: #0f172a;">{{ model.name }}</div>
                        <div style="color: #64748b; margin-top: 0.25rem;">
                            Tokens: {{ "{:,}".format(model.total_tokens) }} |
                            è°ƒç”¨: {{ model.call_count }} æ¬¡ |
                            è´¹ç”¨: Â¥{{ "%.2f"|format(model.cost) }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </details>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div style="padding: 3rem; text-align: center; color: #64748b;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“Š</div>
            <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">æš‚æ— ä½¿ç”¨æ•°æ®</div>
            <div style="font-size: 0.875rem;">é€‰æ‹©çš„æ—¶é—´èŒƒå›´å†…æœªäº§ç”Ÿä»»ä½•LLM APIè°ƒç”¨</div>
        </div>
    {% endif %}
</div>

<!-- æç¤ºä¿¡æ¯ -->
<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem 1.25rem; border-radius: 8px;">
    <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
        <span>ğŸ’¡</span>
        <span>è´¹ç”¨è¯´æ˜</span>
    </div>
    <ul style="margin: 0; padding-left: 1.25rem; color: #92400e; font-size: 0.875rem;">
        <li>è´¹ç”¨åŸºäºå„æä¾›å•†çš„å…¬å¼€å®šä»·è®¡ç®—ï¼Œå®é™…è´¦å•å¯èƒ½ç•¥æœ‰å·®å¼‚</li>
        <li>Tokenç»Ÿè®¡åŒ…å«è¾“å…¥å’Œè¾“å‡ºTokenæ€»å’Œ</li>
        <li>å»ºè®®è®¾ç½®æœˆåº¦é¢„ç®—é™é¢ï¼Œé¿å…è¶…æ”¯</li>
        <li>å¯å¯¼å‡ºè¯¦ç»†è´¦å•ç”¨äºè´¢åŠ¡å®¡æ ¸</li>
    </ul>
</div>

{% endblock %}
