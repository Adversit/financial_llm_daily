{% extends "base.html" %}

{% block breadcrumb %}ç³»ç»ŸçŠ¶æ€{% endblock %}

{% block content %}
<style>
    /* ç³»ç»ŸçŠ¶æ€ç›‘æ§æ ·å¼ */
    .status-header {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        border-radius: 12px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(250, 112, 154, 0.2);
    }

    .status-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .status-subtitle {
        font-size: 0.9375rem;
        opacity: 0.95;
    }

    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .status-card {
        background: white;
        border-radius: 12px;
        padding: 1.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

    .status-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1.5rem;
    }

    .status-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .icon-green {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .icon-blue {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .icon-orange {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .icon-red {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-healthy {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-error {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-card-title {
        font-size: 0.875rem;
        color: #64748b;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-card-value {
        font-size: 2rem;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 1rem;
    }

    .status-detail-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .status-detail-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        font-size: 0.875rem;
        border-top: 1px solid #f1f5f9;
    }

    .status-detail-item:first-child {
        border-top: none;
    }

    .detail-label {
        color: #64748b;
    }

    .detail-value {
        color: #0f172a;
        font-weight: 500;
    }

    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .chart-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #0f172a;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chart-placeholder {
        height: 250px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        font-size: 0.875rem;
    }

    .service-list {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .service-list-header {
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid #e2e8f0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .service-item {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #f1f5f9;
        display: grid;
        grid-template-columns: 48px 1fr auto;
        gap: 1rem;
        align-items: center;
        transition: background-color 0.2s;
    }

    .service-item:hover {
        background: #fafbfc;
    }

    .service-item:last-child {
        border-bottom: none;
    }

    .service-status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .dot-green {
        background: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    .dot-yellow {
        background: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }

    .dot-red {
        background: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }

    .service-info-name {
        font-weight: 600;
        color: #0f172a;
        margin-bottom: 0.25rem;
    }

    .service-info-desc {
        font-size: 0.8125rem;
        color: #64748b;
    }

    .service-metrics {
        text-align: right;
        font-size: 0.875rem;
        color: #64748b;
    }
</style>

<!-- é¡µé¢å¤´éƒ¨ -->
<div class="status-header">
    <div class="status-title">ğŸ“ˆ ç³»ç»ŸçŠ¶æ€</div>
    <div class="status-subtitle">å®æ—¶ç›‘æ§ç³»ç»Ÿå„ç»„ä»¶è¿è¡ŒçŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡</div>
</div>

<!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
<div class="status-grid">
    <!-- PostgreSQL æ•°æ®åº“ -->
    <div class="status-card">
        <div class="status-card-header">
            <div class="status-card-icon {{ 'icon-green' if status.database.status == 'healthy' else 'icon-red' }}">
                {{ 'ğŸ’š' if status.database.status == 'healthy' else 'â¤ï¸' }}
            </div>
            <div class="status-badge {{ 'badge-healthy' if status.database.status == 'healthy' else 'badge-error' }}">
                {{ 'æ­£å¸¸' if status.database.status == 'healthy' else 'é”™è¯¯' }}
            </div>
        </div>
        <div class="status-card-title">PostgreSQL æ•°æ®åº“</div>
        <div class="status-card-value">
            {{ status.database.details.response_time_ms if status.database.details.get('response_time_ms') else '--' }} ms
        </div>
        <ul class="status-detail-list">
            <li class="status-detail-item">
                <span class="detail-label">è¿æ¥æ•°</span>
                <span class="detail-value">{{ status.database.details.connections if status.database.details.get('connections') is not none else '--' }}</span>
            </li>
            <li class="status-detail-item">
                <span class="detail-label">å“åº”æ—¶é—´</span>
                <span class="detail-value">{{ status.database.details.response_time_ms if status.database.details.get('response_time_ms') else '--' }} ms</span>
            </li>
            <li class="status-detail-item">
                <span class="detail-label">æ•°æ®åº“å¤§å°</span>
                <span class="detail-value">{{ status.database.details.size_mb if status.database.details.get('size_mb') else '--' }} MB</span>
            </li>
        </ul>
    </div>

    <!-- Redis ç¼“å­˜ -->
    <div class="status-card">
        <div class="status-card-header">
            <div class="status-card-icon {{ 'icon-blue' if status.redis.status == 'healthy' else 'icon-red' }}">
                {{ 'ğŸ’™' if status.redis.status == 'healthy' else 'â¤ï¸' }}
            </div>
            <div class="status-badge {{ 'badge-healthy' if status.redis.status == 'healthy' else 'badge-error' }}">
                {{ 'æ­£å¸¸' if status.redis.status == 'healthy' else 'é”™è¯¯' }}
            </div>
        </div>
        <div class="status-card-title">Redis ç¼“å­˜</div>
        <div class="status-card-value">{{ status.redis.details.hit_rate if status.redis.details.get('hit_rate') is not none else '--' }}%</div>
        <ul class="status-detail-list">
            <li class="status-detail-item">
                <span class="detail-label">å†…å­˜ä½¿ç”¨</span>
                <span class="detail-value">{{ status.redis.details.used_memory_human if status.redis.details.get('used_memory_human') else '--' }}</span>
            </li>
            <li class="status-detail-item">
                <span class="detail-label">é”®æ•°é‡</span>
                <span class="detail-value">{{ "{:,}".format(status.redis.details.key_count) if status.redis.details.get('key_count') is not none else '--' }}</span>
            </li>
            <li class="status-detail-item">
                <span class="detail-label">å‘½ä¸­ç‡</span>
                <span class="detail-value">{{ status.redis.details.hit_rate if status.redis.details.get('hit_rate') is not none else '--' }}%</span>
            </li>
        </ul>
    </div>

    <!-- Celery ä»»åŠ¡é˜Ÿåˆ— -->
    <div class="status-card">
        <div class="status-card-header">
            <div class="status-card-icon {{ 'icon-orange' if status.celery.details.get('queue_length', 0) > 10 else 'icon-green' if status.celery.status == 'healthy' else 'icon-red' }}">
                {{ 'ğŸ§¡' if status.celery.details.get('queue_length', 0) > 10 else 'ğŸ’š' if status.celery.status == 'healthy' else 'â¤ï¸' }}
            </div>
            <div class="status-badge {{ 'badge-warning' if status.celery.details.get('queue_length', 0) > 10 else 'badge-healthy' if status.celery.status == 'healthy' else 'badge-error' }}">
                {{ 'ç¹å¿™' if status.celery.details.get('queue_length', 0) > 10 else 'æ­£å¸¸' if status.celery.status == 'healthy' else 'é”™è¯¯' }}
            </div>
        </div>
        <div class="status-card-title">Celery ä»»åŠ¡é˜Ÿåˆ—</div>
        <div class="status-card-value">{{ status.celery.details.worker_count if status.celery.details.get('worker_count') is not none else '--' }} Workers</div>
        <ul class="status-detail-list">
            <li class="status-detail-item">
                <span class="detail-label">æ´»è·ƒä»»åŠ¡</span>
                <span class="detail-value">{{ status.celery.details.active_tasks if status.celery.details.get('active_tasks') is not none else '--' }}</span>
            </li>
            <li class="status-detail-item">
                <span class="detail-label">å¾…å¤„ç†</span>
                <span class="detail-value">{{ status.celery.details.queue_length if status.celery.details.get('queue_length') is not none else '--' }}</span>
            </li>
            <li class="status-detail-item">
                <span class="detail-label">ä»Šæ—¥å®Œæˆ</span>
                <span class="detail-value">{{ status.celery.details.completed_today if status.celery.details.get('completed_today') is not none else '--' }}</span>
            </li>
        </ul>
    </div>

    <!-- Web æœåŠ¡ -->
    <div class="status-card">
        <div class="status-card-header">
            <div class="status-card-icon {{ 'icon-green' if status.web.status == 'healthy' else 'icon-red' }}">
                {{ 'ğŸ’š' if status.web.status == 'healthy' else 'â¤ï¸' }}
            </div>
            <div class="status-badge {{ 'badge-healthy' if status.web.status == 'healthy' else 'badge-error' }}">
                {{ 'æ­£å¸¸' if status.web.status == 'healthy' else 'é”™è¯¯' }}
            </div>
        </div>
        <div class="status-card-title">Web æœåŠ¡</div>
        <div class="status-card-value">è¿è¡Œä¸­</div>
        <ul class="status-detail-list">
            <li class="status-detail-item">
                <span class="detail-label">æ–‡ç« æ•°</span>
                <span class="detail-value">{{ "{:,}".format(status.database.details.articles) if status.database.details.get('articles') is not none else '--' }}</span>
            </li>
            <li class="status-detail-item">
                <span class="detail-label">æŠ¥å‘Šæ•°</span>
                <span class="detail-value">{{ "{:,}".format(status.database.details.reports) if status.database.details.get('reports') is not none else '--' }}</span>
            </li>
            <li class="status-detail-item">
                <span class="detail-label">æŠ½å–æ¡ç›®</span>
                <span class="detail-value">{{ "{:,}".format(status.database.details.extractions) if status.database.details.get('extractions') is not none else '--' }}</span>
            </li>
        </ul>
    </div>
</div>

<!-- æ€§èƒ½å›¾è¡¨ -->
<div class="chart-container">
    <div class="chart-title">
        <span>ğŸ“Š</span>
        <span>ç³»ç»Ÿæ€§èƒ½è¶‹åŠ¿ï¼ˆæœ€è¿‘24å°æ—¶ï¼‰</span>
    </div>
    <div id="performanceChart" style="height: 400px;"></div>
</div>

<!-- ECharts JS -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    // åˆå§‹åŒ–å›¾è¡¨
    const chart = echarts.init(document.getElementById('performanceChart'));

    // åŠ è½½æ€§èƒ½æ•°æ®
    async function loadPerformanceData() {
        try {
            const response = await fetch('/admin/status/metrics');
            const data = await response.json();

            // é…ç½®å›¾è¡¨é€‰é¡¹
            const option = {
                title: {
                    text: 'ç³»ç»Ÿæ€§èƒ½ç›‘æ§',
                    left: 'center',
                    textStyle: {
                        color: '#0f172a',
                        fontSize: 16,
                        fontWeight: 600
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['CPUä½¿ç”¨ç‡', 'å†…å­˜ä½¿ç”¨ç‡', 'æ•°æ®åº“è¿æ¥æ•°', 'Rediså†…å­˜'],
                    bottom: 10,
                    textStyle: {
                        fontSize: 12
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: data.timestamps,
                    axisLabel: {
                        rotate: 45,
                        fontSize: 11
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'ä½¿ç”¨ç‡ (%)',
                        position: 'left',
                        axisLabel: {
                            formatter: '{value}%'
                        },
                        min: 0,
                        max: 100
                    },
                    {
                        type: 'value',
                        name: 'è¿æ¥æ•°',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}'
                        }
                    }
                ],
                series: [
                    {
                        name: 'CPUä½¿ç”¨ç‡',
                        type: 'line',
                        smooth: true,
                        data: data.metrics.cpu,
                        yAxisIndex: 0,
                        itemStyle: {
                            color: '#3b82f6'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(59, 130, 246, 0.3)' },
                                { offset: 1, color: 'rgba(59, 130, 246, 0.05)' }
                            ])
                        }
                    },
                    {
                        name: 'å†…å­˜ä½¿ç”¨ç‡',
                        type: 'line',
                        smooth: true,
                        data: data.metrics.memory,
                        yAxisIndex: 0,
                        itemStyle: {
                            color: '#10b981'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(16, 185, 129, 0.3)' },
                                { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
                            ])
                        }
                    },
                    {
                        name: 'æ•°æ®åº“è¿æ¥æ•°',
                        type: 'line',
                        smooth: true,
                        data: data.metrics.db_connections,
                        yAxisIndex: 1,
                        itemStyle: {
                            color: '#f59e0b'
                        }
                    },
                    {
                        name: 'Rediså†…å­˜',
                        type: 'line',
                        smooth: true,
                        data: data.metrics.redis_memory,
                        yAxisIndex: 0,
                        itemStyle: {
                            color: '#ef4444'
                        }
                    }
                ]
            };

            chart.setOption(option);
        } catch (error) {
            console.error('åŠ è½½æ€§èƒ½æ•°æ®å¤±è´¥:', error);
            document.getElementById('performanceChart').innerHTML =
                '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #64748b;">åŠ è½½æ•°æ®å¤±è´¥,è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
        }
    }

    // åˆå§‹åŠ è½½
    loadPerformanceData();

    // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°æ•°æ®
    setInterval(loadPerformanceData, 3000000);

    // çª—å£å¤§å°æ”¹å˜æ—¶è‡ªåŠ¨è°ƒæ•´å›¾è¡¨
    window.addEventListener('resize', () => {
        chart.resize();
    });
</script>

<!-- æœåŠ¡åˆ—è¡¨ -->
<div class="service-list">
    <div class="service-list-header">
        <span>âš™ï¸</span>
        <span>æœåŠ¡ç»„ä»¶çŠ¶æ€</span>
    </div>

    <div class="service-item">
        <div style="display: flex; align-items: center; justify-content: center;">
            <span class="service-status-dot dot-green"></span>
        </div>
        <div>
            <div class="service-info-name">FastAPI Web Server</div>
            <div class="service-info-desc">ä¸»WebæœåŠ¡ - ç«¯å£ 8000</div>
        </div>
        <div class="service-metrics">
            è¿è¡Œæ—¶é—´: 3å¤© 12å°æ—¶
        </div>
    </div>

    <div class="service-item">
        <div style="display: flex; align-items: center; justify-content: center;">
            <span class="service-status-dot dot-green"></span>
        </div>
        <div>
            <div class="service-info-name">PostgreSQL Database</div>
            <div class="service-info-desc">ä¸»æ•°æ®åº“ - ç«¯å£ 5432</div>
        </div>
        <div class="service-metrics">
            è¿è¡Œæ—¶é—´: 5å¤© 8å°æ—¶
        </div>
    </div>

    <div class="service-item">
        <div style="display: flex; align-items: center; justify-content: center;">
            <span class="service-status-dot dot-green"></span>
        </div>
        <div>
            <div class="service-info-name">Redis Cache</div>
            <div class="service-info-desc">ç¼“å­˜æœåŠ¡ - ç«¯å£ 6379</div>
        </div>
        <div class="service-metrics">
            è¿è¡Œæ—¶é—´: 5å¤© 8å°æ—¶
        </div>
    </div>

    <div class="service-item">
        <div style="display: flex; align-items: center; justify-content: center;">
            <span class="service-status-dot dot-yellow"></span>
        </div>
        <div>
            <div class="service-info-name">Celery Worker</div>
            <div class="service-info-desc">åå°ä»»åŠ¡å¤„ç†</div>
        </div>
        <div class="service-metrics">
            è¿è¡Œæ—¶é—´: 2å¤© 16å°æ—¶
        </div>
    </div>

    <div class="service-item">
        <div style="display: flex; align-items: center; justify-content: center;">
            <span class="service-status-dot dot-green"></span>
        </div>
        <div>
            <div class="service-info-name">Celery Beat</div>
            <div class="service-info-desc">å®šæ—¶ä»»åŠ¡è°ƒåº¦</div>
        </div>
        <div class="service-metrics">
            è¿è¡Œæ—¶é—´: 2å¤© 16å°æ—¶
        </div>
    </div>

    <div class="service-item">
        <div style="display: flex; align-items: center; justify-content: center;">
            <span class="service-status-dot dot-green"></span>
        </div>
        <div>
            <div class="service-info-name">SMTPé‚®ä»¶æœåŠ¡</div>
            <div class="service-info-desc">é‚®ä»¶å‘é€æœåŠ¡</div>
        </div>
        <div class="service-metrics">
            ä»Šæ—¥å‘é€: 35å°
        </div>
    </div>
</div>

<!-- æç¤ºä¿¡æ¯ -->
<div style="background: #eff6ff; border-left: 4px solid #2563eb; padding: 1rem 1.25rem; border-radius: 8px; margin-top: 2rem;">
    <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
        <span>ğŸ’¡</span>
        <span>ç›‘æ§è¯´æ˜</span>
    </div>
    <ul style="margin: 0; padding-left: 1.25rem; color: #1e40af; font-size: 0.875rem;">
        <li>ç³»ç»ŸçŠ¶æ€æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡</li>
        <li>ç»¿è‰²è¡¨ç¤ºæ­£å¸¸ï¼Œé»„è‰²è¡¨ç¤ºè­¦å‘Šï¼Œçº¢è‰²è¡¨ç¤ºé”™è¯¯</li>
        <li>å¯é…ç½®ç›‘æ§é˜ˆå€¼å’Œå‘Šè­¦é€šçŸ¥</li>
    </ul>
</div>

{% endblock %}
