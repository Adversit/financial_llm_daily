# é‡‘èæƒ…æŠ¥æ—¥æŠ¥ç³»ç»Ÿ - ç¬¬ä¸€é˜¶æ®µæ¨¡å—æ¶æ„å›¾ (MVP)

**ç‰ˆæœ¬**: v1.1 (å·²å®ç°)
**æ—¥æœŸ**: 2025-11-06
**çŠ¶æ€**: âœ… æ‰€æœ‰æ ¸å¿ƒæ¨¡å—å·²å®Œæˆ

---

## ğŸ“ ç³»ç»Ÿåˆ†å±‚æ¶æ„

### 1ï¸âƒ£ è°ƒåº¦å±‚ (Orchestration Layer)

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| **Celery Beat** | `src/tasks/celery_app.py` | âœ… | å®šæ—¶è°ƒåº¦ï¼Œæ¯æ—¥ 05:30 å¯åŠ¨ |
| **Celery Worker** | `src/tasks/celery_app.py` | âœ… | å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ |
| **Redis** | Docker | âœ… | é˜Ÿåˆ—/è°ƒåº¦/ç¼“å­˜ |
| **FastAPI** | `src/api/main.py` | âœ… | å¥åº·æ£€æŸ¥ `/healthz` |
| **CLI** | `src/cli/run_once.py` | âœ… | æ‰‹åŠ¨è§¦å‘å·¥å…· |
| **Orchestrator** | `src/tasks/orchestrator.py` | âœ… | ä»»åŠ¡ç¼–æ’å™¨ï¼ˆchain/groupï¼‰ |

**ä»»åŠ¡é˜Ÿåˆ—é…ç½®**:
```python
task_routes={
    "src.tasks.crawl_tasks.*": {"queue": "crawl"},
    "src.tasks.extract_tasks.*": {"queue": "extract"},
    "src.tasks.report_tasks.*": {"queue": "report"},
    "src.tasks.mail_tasks.*": {"queue": "mail"},
}
```

---

### 2ï¸âƒ£ æ ¸å¿ƒä¸šåŠ¡æ¨¡å—å±‚ (Core Modules)

#### ğŸ…°ï¸ æ¨¡å— A: ä¿¡æ¯æºé‡‡é›† (Ingestion)

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| **åŸºç¡€æ¡†æ¶** | `src/crawlers/base.py` | âœ… | BaseCrawler æŠ½è±¡ç±» |
| **RSS é‡‡é›†å™¨** | `src/crawlers/rss_crawler.py` | âœ… | feedparserï¼Œå¹¶å‘=10/Dev, 2/Prod |
| **é™æ€ç½‘ç«™é‡‡é›†** | `src/crawlers/static_crawler.py` | âœ… | requests + trafilaturaï¼Œå¹¶å‘=2 |
| **æ­£æ–‡æå–å™¨** | `src/crawlers/text_extractor.py` | âœ… | trafilaturaâ†’readabilityâ†’XPath |
| **å»é‡å¼•æ“** | `src/crawlers/deduplicator.py` | âœ… | SimHash + URL è§„èŒƒåŒ– |
| **é‡‡é›†ä»»åŠ¡** | `src/tasks/crawl_tasks.py` | âœ… | crawl_rss_task, crawl_static_task |

**é‡‡é›†æµç¨‹**:
```
RSS/ç½‘ç«™æº â†’ é‡‡é›† â†’ æ­£æ–‡æå– â†’ 24hè¿‡æ»¤ â†’ å»é‡ â†’ articlesè¡¨ + extraction_queueè¡¨
```

**å»é‡ç­–ç•¥**:
- **ä¸€çº§å»é‡**: canonical_url / æ ‡å‡†åŒ–URL+æ ‡é¢˜+æ—¶é—´
- **äºŒçº§å»é‡**: SimHashï¼Œæ±‰æ˜è·â‰¤3
- **ä¿ç•™ç­–ç•¥**: æ—¶é—´æ›´æ—© / æ¥æºæƒå¨

---

#### ğŸ…±ï¸ æ¨¡å— B: ä¿¡æ¯å¤„ç† (LLM Extraction)

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| **åˆ†å—å¼•æ“** | `src/nlp/chunking.py` | âœ… | è¯­ä¹‰åˆ‡åˆ†ï¼Œé¢„ç®—70%ï¼Œé‡å 200å­— |
| **Provider è·¯ç”±** | `src/nlp/provider_router.py` | âœ… | DeepSeekâ†’Qwenï¼Œè¶…æ—¶90sï¼Œé‡è¯•2æ¬¡ |
| **LLM æŠ½å–å™¨** | `src/nlp/extractor.py` | âœ… | ç»“æ„åŒ–æŠ½å– fact/opinion/region/layer |
| **åˆå¹¶å»é‡å™¨** | `src/nlp/merger.py` | âœ… | äº‹å®å½’ä¸€åŒ–ï¼Œç½®ä¿¡åº¦èšåˆ |
| **æŠ½å–ä»»åŠ¡** | `src/tasks/extract_tasks.py` | âœ… | extract_article_task, run_extraction_batch |

**LLM Provider é…ç½®**:
- **ä¸»**: DeepSeek Chat (`deepseek-chat`)
- **å¤‡**: Qwen Max/Plus (`qwen-max`)
- **é€‚é…ä½**: æ”¯æŒ OpenAI å…¼å®¹æ¥å£

**æŠ½å–æµç¨‹**:
```
extraction_queue â†’ è¯»å– articles â†’ åˆ†å— (â‰¤8æ®µ) â†’ é€æ®µLLMè°ƒç”¨ â†’ JSONè§£æ â†’ åˆå¹¶å»é‡ â†’ extraction_itemsè¡¨
```

**é™çº§ç­–ç•¥**:
- `summary_then_extract`: å…ˆæè¦ï¼Œå†åˆ†å—æŠ½å–
- `headN_plus_overall`: å‰Næ®µ + å…¨æ–‡æ¦‚æ‹¬

---

#### ğŸ…² æ¨¡å— C: æŠ¥å‘Šç”Ÿæˆ (Composer)

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| **è¯„åˆ†å™¨** | `src/composer/scorer.py` | âœ… | è¿‡æ»¤+è¯„åˆ†+åˆ†åŒºæ’åº |
| **æŠ¥å‘Šæ„å»ºå™¨** | `src/composer/builder.py` | âœ… | HTML ç”Ÿæˆï¼Œæ”¯æŒåˆ†åŒºæŠ¥å‘Šç”Ÿæˆ |
| **LLM åˆ†åŒºæŠ¥å‘Šç”Ÿæˆå™¨** | `src/composer/llm_report_generator.py` | âœ… | AI ç”Ÿæˆ 8 ä¸ªåˆ†åŒºæŠ¥å‘Šï¼Œå…¨é‡è¾“å…¥+token åˆ†å— |
| **é‚®ä»¶æ­£æ–‡æ¨¡æ¿** | `src/composer/templates/email_body.html` | âœ… | 8 åˆ†åŒºæŠ¥å‘Š+TopN å¡ç‰‡ |
| **é™„ä»¶æ¨¡æ¿** | `src/composer/templates/attachment.html` | âœ… | å…¨é‡äº‹å®è§‚ç‚¹+URL æº¯æº+åˆ†åŒºå±•ç¤º |
| **æŠ¥å‘Šä»»åŠ¡** | `src/tasks/report_tasks.py` | âœ… | build_report_task |

**è¯„åˆ†å…¬å¼**:
```
score = 0.5 Ã— å½±å“åŠ› + 0.3 Ã— æ–°è¿‘åº¦ + 0.2 Ã— æƒå¨æ€§
```

**è¿‡æ»¤æ¡ä»¶**:
- confidence â‰¥ 0.6
- content_len â‰¥ 120å­—
- processing_status = 'done'

**åˆ†åŒºç»“æ„**:
```
å›½å†…/å›½å¤– Ã— (æ”¿æ²» | ç»æµ | é‡‘èå¤§æ¨¡å‹æŠ€æœ¯ | é‡‘èç§‘æŠ€)
```

**AI åˆ†åŒºæŠ¥å‘Šç”Ÿæˆ**:
- **æ¨¡å¼åˆ‡æ¢**: `REPORT_USE_LLM_SECTIONS=True/False`
- **åˆ†åŒºæ•°é‡**: 8 ä¸ªï¼ˆå›½å†…/å›½å¤– Ã— 4 å±‚çº§ï¼‰
- **è¾“å…¥æ•°æ®**: æ¯ä¸ªåˆ†åŒºçš„å…¨éƒ¨äº‹å® + è§‚ç‚¹ï¼ŒæŒ‰è¯„åˆ†æ’åº
- **Token é™åˆ¶**: 8000 tokens * 60% = 4800ï¼Œè¶…å‡ºè‡ªåŠ¨åˆ†å—
- **åˆ†å—ç­–ç•¥**: æ¯å—æœ€å¤š 20 æ¡ï¼Œç”Ÿæˆå­æŠ¥å‘Šåæ±‡æ€»
- **æŠ¥å‘Šé•¿åº¦**: 150-250 å­—/åˆ†åŒº

---

#### ğŸ…³ æ¨¡å— D: é‚®ä»¶æŠ•é€’ (Mailer)

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| **SMTP å®¢æˆ·ç«¯** | `src/mailer/smtp_client.py` | âœ… | ç½‘æ˜“ SSL 465ï¼Œæˆæƒç ç™»å½• |
| **åˆ†æ‰¹ä¸èŠ‚æµå™¨** | `src/mailer/batcher.py` | âœ… | æœ€å¤š50äºº/å°ï¼Œ1å°/ç§’ |
| **é‡è¯•ä¸é€€ä¿¡å¤„ç†** | `src/mailer/retry_handler.py` | âœ… | å¤±è´¥é‡è¯•2æ¬¡ï¼Œç¡¬é€€ä¿¡é»‘åå• |
| **é‚®ä»¶ä»»åŠ¡** | `src/tasks/mail_tasks.py` | âœ… | send_report_task |

**é‚®ä»¶æ ¼å¼**:
- **ä¸»é¢˜**: `é‡‘èæƒ…æŠ¥æ—¥æŠ¥-YYYY-MM-DD`
- **æ­£æ–‡**: HTML (TopN å¡ç‰‡)
- **é™„ä»¶**: `daily-report-YYYY-MM-DD.html` (å…¨é‡)

**å‘é€æ§åˆ¶**:
- **çª—å£**: 06:05-06:20
- **åˆ†æ‰¹**: To + BCCï¼Œæœ€å¤š50äºº/å°
- **èŠ‚æµ**: 1å°/ç§’

---

### 3ï¸âƒ£ æ•°æ®æŒä¹…å±‚ (Persistence Layer)

| è¡¨å | æ–‡ä»¶è·¯å¾„ | ç”¨é€” |
|------|---------|------|
| **sources** | `src/models/source.py` | ä¿¡æ¯æºé…ç½® |
| **articles** | `src/models/article.py` | æ–‡ç« å†…å®¹ |
| **extraction_queue** | `src/models/extraction.py` | æŠ½å–é˜Ÿåˆ— |
| **extraction_items** | `src/models/extraction.py` | äº‹å®è§‚ç‚¹ |
| **reports** | `src/models/report.py` | æŠ¥å‘Šå­˜å‚¨ |
| **report_recipients** | `src/models/report.py` | æ”¶ä»¶äººåˆ—è¡¨ |
| **delivery_log** | `src/models/delivery.py` | æŠ•é€’æ—¥å¿— |
| **provider_usage** | `src/models/extraction.py` | Token ç»Ÿè®¡ |

---

### 4ï¸âƒ£ ç³»ç»Ÿæ”¯æ’‘æ¨¡å— (System Support)

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| **é…ç½®ç®¡ç†** | `src/config/settings.py` | âœ… | Pydantic Settings |
| **æ—¥å¿—ç³»ç»Ÿ** | `src/utils/logger.py` | âœ… | loguruï¼Œå¤šçº§åˆ«è½®è½¬ |
| **å¯åŠ¨è‡ªæ£€** | `src/utils/bootstrap.py` | âœ… | ä¾èµ–/DB/Redis/è¡¨æ£€æŸ¥ |
| **å¥åº·æ£€æŸ¥** | `src/api/routes/health.py` | âœ… | `/healthz` ç«¯ç‚¹ |
| **é‡è¯•å·¥å…·** | `src/utils/retry.py` | âœ… | æŒ‡æ•°é€€é¿é‡è¯• |
| **æ—¶é—´å·¥å…·** | `src/utils/time_utils.py` | âœ… | æ—¶åŒºå¤„ç† |

---

## ğŸ”„ å®Œæ•´æ•°æ®æµï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰

```
05:30  Celery Beat è§¦å‘ (chain å¯åŠ¨)
         â†“
       é‡‡é›†ä»»åŠ¡ (group å¹¶å‘)
         â†“ ç­‰å¾…é‡‡é›†å®Œæˆ (10-35 åˆ†é’Ÿ)
     articles è¡¨ + extraction_queue è¡¨
         â†“
       æ‰¹é‡æŠ½å– (LLM)
         â†“ ç­‰å¾…æŠ½å–å®Œæˆ (5-15 åˆ†é’Ÿ)
     extraction_items è¡¨
         â†“
       æŠ¥å‘Šç”Ÿæˆ (è¯„åˆ†+HTML)
         â†“ ç­‰å¾…æˆç¨¿å®Œæˆ (2-5 åˆ†é’Ÿ)
     reports è¡¨
         â†“
       é‚®ä»¶æŠ•é€’ (åˆ†æ‰¹èŠ‚æµ)
         â†“ ç­‰å¾…å‘é€å®Œæˆ (1-10 åˆ†é’Ÿ)
     delivery_log è¡¨
         â†“
~07:00 å®Œæˆ (æ€»è®¡ 18-65 åˆ†é’Ÿ)

æ‰§è¡Œæ¨¡å¼ï¼šä¸²è¡Œ (Celery chain)
- å„æ¨¡å—è‡ªåŠ¨ç­‰å¾…ä¸Šä¸€æ¨¡å—å®Œæˆ
- æ— æ—¶é—´çª—å£é™åˆ¶ï¼ŒåŠ¨æ€è°ƒæ•´
- æœ€é«˜ç¨³å®šæ€§ï¼Œé€‚é… 2C/2G æœåŠ¡å™¨
```

---

## ğŸ“Š å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | å¼€å‘ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|------|---------|---------|
| **è°ƒåº¦æ—¶é—´** | æ¯æ—¥ 05:30 å¯åŠ¨ | æ¯æ—¥ 05:30 å¯åŠ¨ |
| **æ‰§è¡Œæ¨¡å¼** | ä¸²è¡Œ (chain) | ä¸²è¡Œ (chain) |
| **é¢„è®¡å®Œæˆ** | 06:30-07:00 | 06:30-07:00 |
| **é‡‡é›†é¢„æœŸ** | 10-35 åˆ†é’Ÿ | 10-35 åˆ†é’Ÿ |
| **RSS å¹¶å‘** | 10 | 2 |
| **ç½‘ç«™å¹¶å‘** | 2 | 2 |
| **LLM è¶…æ—¶** | 90sï¼Œé‡è¯•2æ¬¡ | 90sï¼Œé‡è¯•2æ¬¡ |
| **é‚®ä»¶èŠ‚æµ** | 1å°/ç§’ï¼Œæœ€å¤š50äºº/å° | 1å°/ç§’ï¼Œæœ€å¤š50äºº/å° |
| **é™„ä»¶é™åˆ¶** | æœ€å¤š 500 æ¡ | æœ€å¤š 500 æ¡ |

---

## âœ… é˜¶æ®µä¸€éªŒæ”¶æ ‡å‡†

| æ¨¡å— | éªŒæ”¶æ ‡å‡† | çŠ¶æ€ |
|------|---------|------|
| **æ¨¡å— A** | articles â‰¥ 10ï¼Œå»é‡ç”Ÿæ•ˆï¼Œextraction_queue å…¥é˜Ÿ | âœ… |
| **æ¨¡å— B** | extraction_items â‰¥ 20ï¼Œåˆ†å—/å›é€€/åˆå¹¶æ­£å¸¸ | âœ… |
| **æ¨¡å— C** | reports = 1ï¼Œæ­£æ–‡ TopN+é™„ä»¶å…¨é‡ï¼Œé“¾æ¥å¯ç”¨ | âœ… |
| **æ¨¡å— D** | çœŸå®é‚®ä»¶å‘é€æˆåŠŸï¼Œdelivery_log å®Œæ•´ | âœ… |
| **ç³»ç»Ÿæ”¯æ’‘** | æ—¥å¿—/å¯åŠ¨è‡ªæ£€/å¥åº·æ£€æŸ¥å®Œæˆï¼Œæµ‹è¯•é€šè¿‡ (16/16) | âœ… |
| **ç«¯åˆ°ç«¯** | CLI `run_once --step all` ä¸€æ¬¡è·‘é€šï¼Œ07:00 å‰å®Œæˆ | â³ å¾…æµ‹è¯• |

---

## ğŸ“ å®ç°è¯´æ˜

### å·²å®ç°åŠŸèƒ½
- âœ… æ‰€æœ‰ 4 ä¸ªæ ¸å¿ƒä¸šåŠ¡æ¨¡å— (A/B/C/D)
- âœ… ç³»ç»Ÿæ”¯æ’‘æ¨¡å— (æ—¥å¿—/å¯åŠ¨è‡ªæ£€/å¥åº·æ£€æŸ¥/ä»»åŠ¡ç¼–æ’)
- âœ… å®Œæ•´çš„ä»»åŠ¡ç¼–æ’å™¨ (orchestrator.py)
- âœ… CLI å·¥å…· (run_once.py)
- âœ… æµ‹è¯•è¦†ç›– (96+ æµ‹è¯•é€šè¿‡)

### æœªå®ç°åŠŸèƒ½ï¼ˆéå¿…éœ€ï¼‰
- âš ï¸ åŠ¨æ€ç½‘ç«™é‡‡é›†å™¨ (Playwright) - è®¡åˆ’ä½œä¸ºå…œåº•ç­–ç•¥
- âš ï¸ é˜Ÿåˆ—æ°´ä½ç›‘æ§ - å¯é€šè¿‡ Redis/Celery åŸç”Ÿå·¥å…·å®ç°
- âš ï¸ æˆæœ¬ç»Ÿè®¡èšåˆ - å·²æœ‰ provider_usage è¡¨è®°å½•

### æŠ€æœ¯æ ˆ
- **åç«¯**: Python 3.11+, FastAPI, Celery
- **æ•°æ®åº“**: PostgreSQL (Docker)
- **ç¼“å­˜**: Redis (Docker)
- **LLM**: DeepSeek Chat, Qwen Max/Plus
- **é‚®ä»¶**: ç½‘æ˜“ SMTP SSL 465
- **æ—¥å¿—**: loguru
- **æ¨¡æ¿**: Jinja2
- **æµ‹è¯•**: pytest

---

**æ›´æ–°æ—¥æœŸ**: 2025-11-06
**æ–‡æ¡£çŠ¶æ€**: ä¸å®é™…ä»£ç å®Œå…¨åŒæ­¥
