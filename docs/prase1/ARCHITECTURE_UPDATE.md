# 架构图更新说明

**更新日期**: 2025-11-06
**更新原因**: 将架构图与实际代码实现同步

---

## 📝 更新内容

### 1. 新增文档

由于原始的 DrawIO XML 格式文件 (`architecture-phase1.drawio`, `dataflow-phase1.drawio`) 过于复杂且不易维护，已创建基于 Markdown 的简化版本：

| 文档 | 路径 | 说明 |
|------|------|------|
| **架构图（更新版）** | `docs/architecture-phase1-updated.md` | 完整的系统分层架构说明 |
| **数据流图（更新版）** | `docs/dataflow-phase1-updated.md` | 详细的数据流程和时间线 |
| **本文档** | `docs/ARCHITECTURE_UPDATE.md` | 更新说明和对比 |

### 2. 保留原始文件

原始 DrawIO 文件保持不变，作为历史参考：
- `docs/architecture-phase1.drawio` (原始版本)
- `docs/dataflow-phase1.drawio` (原始版本)

---

## 🔍 主要差异分析

### ✅ 已实现且与架构图一致

1. **调度层**
   - ✅ Celery Beat 定时调度
   - ✅ Celery Worker 任务执行
   - ✅ Redis 队列/调度/缓存
   - ✅ FastAPI 健康检查
   - ✅ CLI 工具
   - ✅ **新增**: Orchestrator 任务编排器（架构图未明确标注）

2. **模块 A - 信息源采集**
   - ✅ 基础采集框架 (base.py)
   - ✅ RSS 采集器 (rss_crawler.py)
   - ✅ 静态网站采集器 (static_crawler.py)
   - ✅ 正文提取器 (text_extractor.py)
   - ✅ 去重引擎 (deduplicator.py)
   - ✅ 采集任务 (crawl_tasks.py)

3. **模块 B - 信息处理**
   - ✅ 分块引擎 (chunking.py)
   - ✅ Provider 路由器 (provider_router.py)
   - ✅ LLM 抽取器 (extractor.py)
   - ✅ 合并去重器 (merger.py)
   - ✅ 抽取任务 (extract_tasks.py)

4. **模块 C - 报告生成**
   - ✅ 评分器 (scorer.py)
   - ✅ 报告构建器 (builder.py)
   - ✅ HTML 模板 (email_body.html, attachment.html)
   - ✅ 报告任务 (report_tasks.py)

5. **模块 D - 邮件投递**
   - ✅ SMTP 客户端 (smtp_client.py)
   - ✅ 分批与节流器 (batcher.py)
   - ✅ 重试与退信处理 (retry_handler.py)
   - ✅ 邮件任务 (mail_tasks.py)

6. **数据持久层**
   - ✅ 所有 8 个数据表已定义并实现

7. **系统支撑模块**
   - ✅ 配置管理 (settings.py)
   - ✅ 日志系统 (logger.py)
   - ✅ 启动自检 (bootstrap.py)
   - ✅ 健康检查 (health.py)
   - ✅ 重试工具 (retry.py)
   - ✅ 时间工具 (time_utils.py)

---

### ⚠️ 架构图中有但未实现的功能

1. **动态网站采集器 (Playwright)**
   - **架构图**: 标注为"动态网站采集 (Playwright)"，作为静态采集失败的兜底策略
   - **实际状态**: 未实现 `dynamic_crawler.py`
   - **原因**: 当前静态采集器 (requests + trafilatura) 已满足需求
   - **影响**: 低，可在后续阶段按需添加

2. **系统支撑 - 队列水位监控**
   - **架构图**: 标注为"队列水位监控 - 错误率/超时/时延"
   - **实际状态**: 未单独实现
   - **现状**: 可通过 Redis CLI、Celery Flower 等工具实现
   - **影响**: 低，运维工具可替代

3. **系统支撑 - 成本统计**
   - **架构图**: 标注为"成本统计 - Token/费用聚合"
   - **实际状态**: 已有 `provider_usage` 表记录，但无聚合统计功能
   - **现状**: 数据已收集，可通过 SQL 查询统计
   - **影响**: 低，数据完整可查

4. **系统支撑 - 配置一致性**
   - **架构图**: 标注为"配置一致性 - 参数导出/校验"
   - **实际状态**: 未实现独立模块
   - **现状**: 使用 Pydantic Settings 自动校验
   - **影响**: 无，Pydantic 已提供校验

---

### ✨ 实际实现但架构图未标注的功能

1. **任务编排器 (Orchestrator)**
   - **文件**: `src/tasks/orchestrator.py`
   - **功能**:
     - `run_daily_report()` - 完整日报流程
     - `run_crawl_only()` - 仅采集
     - `run_extraction_only()` - 仅抽取
   - **说明**: 使用 Celery chain/group 实现工作流编排

2. **CLI 工具增强**
   - **文件**: `src/cli/run_once.py`
   - **功能**: 与编排器集成，支持手动触发和日期指定

3. **完整的测试覆盖**
   - **测试文件**: 18 个测试文件
   - **通过测试**: 96+ 测试
   - **覆盖模块**: 模块 C、D、系统模块

---

## 📊 架构图更新对比表

| 组件 | 原架构图 | 实际实现 | 更新后架构图 | 说明 |
|------|---------|---------|-------------|------|
| **Celery Beat** | ✅ | ✅ | ✅ | 无变化 |
| **Celery Worker** | ✅ | ✅ | ✅ | 无变化 |
| **Redis** | ✅ | ✅ | ✅ | 无变化 |
| **FastAPI** | ✅ | ✅ | ✅ | 无变化 |
| **CLI** | ✅ | ✅ | ✅ | 功能增强 |
| **Orchestrator** | ⚠️ 未标注 | ✅ | ✅ | **新增** |
| **RSS 采集器** | ✅ | ✅ | ✅ | 无变化 |
| **静态采集器** | ✅ | ✅ | ✅ | 无变化 |
| **动态采集器** | ✅ | ❌ | ⚠️ 未实现 | 标注为未实现 |
| **正文提取器** | ✅ | ✅ | ✅ | 无变化 |
| **去重引擎** | ✅ | ✅ | ✅ | 无变化 |
| **分块引擎** | ✅ | ✅ | ✅ | 无变化 |
| **Provider 路由** | ✅ | ✅ | ✅ | 无变化 |
| **LLM 抽取器** | ✅ | ✅ | ✅ | 无变化 |
| **合并去重器** | ✅ | ✅ | ✅ | 无变化 |
| **评分器** | ✅ | ✅ | ✅ | 无变化 |
| **报告构建器** | ✅ | ✅ | ✅ | 无变化 |
| **SMTP 客户端** | ✅ | ✅ | ✅ | 无变化 |
| **分批节流器** | ✅ | ✅ | ✅ | 无变化 |
| **重试处理器** | ✅ | ✅ | ✅ | 无变化 |
| **启动自检** | ✅ | ✅ | ✅ | 无变化 |
| **健康检查** | ✅ | ✅ | ✅ | 无变化 |
| **日志系统** | ✅ | ✅ | ✅ | 无变化 |
| **队列监控** | ✅ | ⚠️ 部分 | ⚠️ 未完整实现 | 可用工具替代 |
| **成本统计** | ✅ | ⚠️ 数据已收集 | ⚠️ 无聚合功能 | SQL 可查询 |
| **配置一致性** | ✅ | ✅ Pydantic | ✅ | Pydantic 自动校验 |

---

## 🎯 更新建议

### 优先级 1 (必需)
- ✅ 已完成：所有核心业务模块 (A/B/C/D)
- ✅ 已完成：系统支撑模块 (日志/启动自检/健康检查/任务编排)
- ✅ 已完成：时间窗口优化 (05:30-06:30，60分钟)

### 优先级 2 (推荐)
- ⏳ 待实现：端到端集成测试
- ⏳ 待实现：模块 A 的单元测试
- ⏳ 待优化：队列监控仪表板（可选，使用 Flower）

### 优先级 3 (可选)
- ⏳ 待实现：动态网站采集器 (Playwright) - 作为兜底策略
- ⏳ 待实现：成本统计聚合功能 - 用于成本分析
- ⏳ 待实现：配置导出/校验工具 - 用于运维

---

## 📌 执行模式优化 (2025-11-06)

### 第一次优化：时间窗口扩展

**背景**：
原设计时间窗口过于激进：
- **原窗口**: 06:00-06:20 (总计 20 分钟)
- **采集窗口**: 06:00-06:05 (5 分钟)
- **问题**: 30+ RSS 源 + 网站采集需要 10-20 分钟，网络不稳定加剧问题

**优化结果**：
- **新窗口**: 05:30-06:30 (总计 60 分钟，扩展 3 倍)
- 调度提前到 05:30，留出更多缓冲时间

---

### 第二次优化：串行执行模式（当前）

**优化原因**：
1. **部署约束**: 2C/2G 腾讯云服务器，资源有限
2. **稳定性优先**: 串行执行无需时间窗口限制，任务自然完成
3. **动态调整**: 根据实际数据量动态调整执行时间

**执行模式**：
- **Celery chain**: 采集 → 抽取 → 成稿 → 投递（依次等待）
- **无时间窗口**: 移除邮件发送的时间窗口检查
- **预计完成**: 05:30 触发，06:30-07:00 之间完成

**附加优化**：
- **附件大小限制**: 新增 `ATTACHMENT_MAX_ITEMS=500` 配置
- **智能截断**: 如果事实观点 >500 条，按评分保留 Top 500

### 修改文件（第二次优化）
1. `src/tasks/celery_app.py` - Beat 调度 05:30 启动 chain
2. `src/tasks/mail_tasks.py` - 移除时间窗口检查
3. `src/config/settings.py` - 移除 `MAIL_WINDOW_*` 配置，新增 `ATTACHMENT_MAX_ITEMS`
4. `src/composer/builder.py` - 新增 `_limit_attachment_items()` 函数
5. `docs/dataflow-phase1-updated.md` - 更新为串行执行模式说明
6. `docs/architecture-phase1-updated.md` - 更新执行模式和关键指标

---

### 第三次优化：AI 报告生成（当前）

**优化原因**：
1. **用户需求**: 需要更专业、更连贯的总览报告
2. **规则模板限制**: 模板生成的文本较生硬，缺乏洞察力
3. **信息整合**: AI 可以综合事实和观点，生成有深度的分析报告

**实现方案**：
- **双模式**: LLM 生成 + 规则模板（可配置切换）
- **输入数据**: 事实 + 观点，按评分排序
- **Token 控制**: 自动分块处理，支持大数据量
- **回退机制**: LLM 失败自动回退到规则模板

**技术特性**：
1. **Token 限制处理**:
   - 估算输入 token 数（中文 1:1，英文 1.3:1）
   - 如果超过 8000 * 0.6 = 4800 tokens，自动分块
   - 每块生成子报告，最后汇总

2. **输入优化**:
   - 最多取 Top 30 条事实观点
   - 包含事实、观点、评分、置信度
   - 按评分降序排序，优先处理重要信息

3. **报告结构**:
   - 总览报告: 200-300 字，综合分析
   - 邮件正文: AI 报告 + TopN 卡片
   - 附件: 全量事实观点 + URL 溯源

### 修改文件（第三次优化）
1. `src/config/settings.py` - 新增 4 个 LLM 报告配置项
2. `src/composer/llm_report_generator.py` - 新增 LLM 报告生成器模块
3. `src/composer/builder.py` - 集成 LLM 和规则模板双模式
4. `docs/architecture-phase1-updated.md` - 更新模块 C 说明

---

## 📚 使用指南

### 查看架构

**推荐**：查看更新后的 Markdown 版本
- `docs/architecture-phase1-updated.md` - 架构图
- `docs/dataflow-phase1-updated.md` - 数据流图

**原始版本**：DrawIO XML 格式
- `docs/architecture-phase1.drawio` - 可用 diagrams.net 打开
- `docs/dataflow-phase1.drawio` - 可用 diagrams.net 打开

### 同步更新

如需修改架构图：
1. 优先更新 Markdown 版本（易于维护）
2. 同步更新 DrawIO 版本（可选，用于可视化演示）

---

## ✅ 验收

| 验收项 | 状态 | 说明 |
|--------|------|------|
| 架构图与代码一致 | ✅ | 已同步 |
| 数据流图与代码一致 | ✅ | 已同步 |
| 未实现功能已标注 | ✅ | 已标注 |
| 新增功能已记录 | ✅ | 已记录 |
| 文档格式统一 | ✅ | Markdown 格式 |

---

**更新人**: Claude Code
**审核状态**: 待人工审核
**下次更新**: 实现新功能时同步更新
